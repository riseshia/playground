events {
    worker_connections 1024;
}

http {
    # ログフォーマットの定義
    log_format realip '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'real_ip=$realip_remote_addr '
                      'x_forwarded_for="$http_x_forwarded_for" '
                      'x_real_ip="$http_x_real_ip"';

    server {
        listen 80;
        server_name localhost;

        # アクセスログに詳細なIPアドレス情報を出力
        access_log /var/log/nginx/access.log realip;
        error_log /var/log/nginx/error.log;

        # realip_module の設定
        # 信頼するプロキシのIPアドレス範囲を指定
        set_real_ip_from 10.0.0.0/8;
        set_real_ip_from 172.16.0.0/12;
        set_real_ip_from 192.168.0.0/16;
        set_real_ip_from 127.0.0.1;

        # どのヘッダーから実際のIPアドレスを取得するか
        real_ip_header X-Forwarded-For;

        # 再帰的に信頼できるIPアドレスをスキップ
        real_ip_recursive on;

        location / {
            # バックエンドにプロキシ
            proxy_pass http://backend:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # realip_remote_addr を追加のヘッダーとして送信
            proxy_set_header X-Original-Remote-Addr $realip_remote_addr;
        }

        # テスト用のエンドポイント: X-Real-IP を使用するケース
        location /test-xrealip {
            real_ip_header X-Real-IP;

            proxy_pass http://backend:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Original-Remote-Addr $realip_remote_addr;
        }

        # テスト用のエンドポイント: recursive off のケース
        location /test-no-recursive {
            real_ip_header X-Forwarded-For;
            real_ip_recursive off;

            proxy_pass http://backend:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Original-Remote-Addr $realip_remote_addr;
        }
    }
}
