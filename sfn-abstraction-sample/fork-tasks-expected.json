{
  "StartAt": "GenNumbers",
  "States": {
    "GenNumbers": {
      "Next": "ForkProcess",
      "Parameters": {
        "ForkNumbers.$": "States.ArrayRange(0, 7, 1)",
        "ForkSize": "8"
      },
      "Type": "Pass"
    },
    "ForkProcess": {
      "ItemProcessor": {
        "ProcessorConfig": {
          "Mode": "INLINE"
        },
        "StartAt": "RunTask",
        "States": {
          "RunTask": {
            "Catch": [
              {
                "ErrorEquals": [
                  "States.ALL"
                ],
                "Next": "ProcessErrorInput",
                "ResultPath": "$.TaskResult"
              }
            ],
            "Next": "MarkingSuccess",
            "Parameters": {
              "Cluster": "service-cluster",
              "EnableExecuteCommand": true,
              "LaunchType": "FARGATE",
              "NetworkConfiguration": {
                "AwsvpcConfiguration": {
                  "SecurityGroups": [
                    "sg-ecs-task"
                  ],
                  "Subnets": [
                    "subnet-private-a",
                    "subnet-private-c",
                    "subnet-private-d"
                  ]
                }
              },
              "Overrides": {
                "ContainerOverrides": [
                  {
                    "Command": [
                      "bundle",
                      "exec",
                      "rails",
                      "routes"
                    ],
                    "Environment": [
                      {
                        "Name": "BATCH_FORK_COUNT",
                        "Value": "8"
                      },
                      {
                        "Name": "BATCH_FORK_NUMBER",
                        "Value.$": "States.Format('{}', $.ForkNumber)"
                      }
                    ],
                    "Name": "app"
                  }
                ],
                "Cpu": null,
                "Memory": null
              },
              "PropagateTags": "TASK_DEFINITION",
              "TaskDefinition": "arn:aws:ecs:ap-northeast-1:xxxx:task-definition/service-batch"
            },
            "Resource": "arn:aws:states:::ecs:runTask.sync",
            "ResultPath": "$.TaskResult",
            "Retry": [
              {
                "BackoffRate": 2,
                "ErrorEquals": [
                  "ECS.AmazonECSException"
                ],
                "IntervalSeconds": 5,
                "MaxAttempts": 4
              }
            ],
            "Type": "Task"
          },
          "ProcessErrorInput": {
            "Next": "CheckError",
            "Parameters": {
              "Cause.$": "States.StringToJson($.TaskResult.Cause)",
              "Error.$": "$.TaskResult.Error",
              "ForkNumber.$": "$.ForkNumber",
              "ForkSize.$": "$.ForkSize"
            },
            "Type": "Pass"
          },
          "CheckError": {
            "Choices": [
              {
                "Next": "Retry",
                "Or": [
                  {
                    "StringEquals": "ResourceInitializationError: failed to configure ENI: failed to setup regular eni: netplugin failed with no error message",
                    "Variable": "$.Cause.StoppedReason"
                  },
                  {
                    "StringEquals": "Unexpected EC2 error while attempting to attach network interface to instance",
                    "Variable": "$.Cause.StoppedReason"
                  }
                ]
              }
            ],
            "Default": "TransformErrorInput",
            "Type": "Choice"
          },
          "MarkingSuccess": {
            "End": true,
            "Result": "Success",
            "Type": "Pass"
          },
          "NotifyFailure": {
            "Next": "MarkingFailure",
            "Parameters": {
              "Message.$": "$.Message",
              "MessageAttributes.$": "$.MessageAttributes",
              "TopicArn": "batch-failure-topic"
            },
            "Resource": "arn:aws:states:::sns:publish",
            "Type": "Task"
          },
          "MarkingFailure": {
            "End": true,
            "Result": "Failure",
            "Type": "Pass"
          },
          "Retry": {
            "Next": "RunTask",
            "Seconds": 60,
            "Type": "Wait"
          },
          "TransformErrorInput": {
            "Next": "NotifyFailure",
            "Parameters": {
              "Message": "Batch failure",
              "MessageAttributes": {
                "BatchName": {
                  "DataType": "String",
                  "StringValue": "fork-task"
                }
              }
            },
            "Type": "Pass"
          }
        }
      },
      "ItemSelector": {
        "ForkNumber.$": "$$.Map.Item.Value",
        "ForkSize.$": "$.ForkSize"
      },
      "ItemsPath": "$.ForkNumbers",
      "Next": "FindFailedMap",
      "Type": "Map"
    },
    "FindFailedMap": {
      "Next": "FinalJudge",
      "Parameters": {
        "HasFailure.$": "States.ArrayContains($, 'Failure')"
      },
      "Type": "Pass"
    },
    "FinalJudge": {
      "Choices": [
        {
          "BooleanEquals": true,
          "Next": "SfnFailed",
          "Variable": "$.HasFailure"
        }
      ],
      "Default": "SfnSucceed",
      "Type": "Choice"
    },
    "SfnFailed": {
      "Type": "Fail"
    },
    "SfnSucceed": {
      "End": true,
      "Type": "Pass"
    }
  }
}
